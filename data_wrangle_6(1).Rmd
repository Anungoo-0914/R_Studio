---
title: "Data Wrangling â€” bikes example"
author: "Anungoo-0914"
date: "2025-12-19"
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1. Install packages

(Only run the install lines once on your machine. In this document they are shown with `eval = FALSE` so they won't run automatically when knitting.)

```{r install-packages, eval=FALSE}
install.packages("readxl")
install.packages("tidyverse") # Only run once
install.packages("tidyquant")
```

# 2. Libraries

```{r load-libraries}
library(tidyverse)
library(tidyquant)
library(readxl)
library(writexl)
library(lubridate)
```

# 3. Data import

Adjust paths if necessary. The example uses the `./FDB_2025F/` directory.

```{r data-import}
bikes_tbl <- read_excel("./FDB_2025F/bikes.xlsx") # fast key: alt+-
bikeshops_tbl <- read_excel("./FDB_2025F/bikeshops.xlsx")
orderlines_tbl <- read_excel("./FDB_2025F/orderlines.xlsx")

# Examine data
bikes_tbl
head(bikes_tbl)

# Import csv file:
bike_orderlines_tbl <- read_csv("./FDB_2025F/bike_orderlines.csv")
```

# 4. Joining data

```{r joins}
# Joining data: 
orderlines_bikes_tbl <- left_join(orderlines_tbl, bikes_tbl, by = c("product.id" = "bike.id"))

bike_orderlines_bikeshops_joined <- left_join(orderlines_bikes_tbl, bikeshops_tbl, 
                                               by = c('customer.id' = 'bikeshop.id'))

# Equivalent pipe chain:
bike_orderlines_bikeshops_joined <- left_join(orderlines_tbl, bikes_tbl, by = c("product.id" = "bike.id")) %>% 
                                    left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))
```

# 5. Wrangling data

Decompose `description`, separate `location`, compute `total.price`, rename and clean names, and save as RDS.

```{r wrangling}
bike_orderlines_wrangled_tbl <- bike_orderlines_bikeshops_joined %>% 
  separate(description, 
           into = c('category.1', 'category.2', 'frame.material'), 
           sep  = ' - ') %>% 
  separate(location, 
           into = c('city', 'state'), 
           sep  = ', ',
           remove = FALSE) %>% 
  # create calculated columns 
  mutate(total.price = price * quantity) %>% 
  # Reorganize columns                                  
  select(-...1, -location) %>% 
  # Reorder columns                                  
  select(contains('date'), contains('id'), 
         contains('order'), 
         quantity, price, total.price, 
         everything()) %>% 
  # Rename columns
  rename(order_date = order.date) %>%
  set_names(names(.) %>% str_replace_all("\\.", "_"))

# save the file as RDS
saveRDS(bike_orderlines_wrangled_tbl, './FDB_2025F/bike_orderlines.rds')
```

# 6. dplyr / tidyr examples

Examples showing pull(), select_if(), arrange(), filter(), distinct(), mutate(), ntile(), case_when(), summarise(), group_by().

```{r dplyr-examples}
# pull() vs select()
bike_orderlines_wrangled_tbl %>% 
  # select(total_price)
  pull(total_price) %>% 
  mean()

# select_if
bike_orderlines_wrangled_tbl %>% 
  # select_if(is.character)
  select_if(is.numeric)

# arrange() and desc()
bikes_tbl %>% 
  select(model, price) %>% 
  arrange(desc(price))

# filter()  
bikes_tbl %>% 
  select(model, price) %>% 
  filter(price > mean(price))

bikes_tbl %>% 
  select(model, price) %>% 
  filter((price > 5000) & (price < 10000)) %>%    
  arrange(desc(price))

bikes_tbl %>% 
  select(model, price) %>% 
  filter(price > 6000, 
         model %>% str_detect("Supersix"))

# Filtering one or more conditions using == and %in%
bike_orderlines_wrangled_tbl %>% 
  filter(category_2 %in% c("Over Mountain", "Trail", "Endurance Road")) %>% 
  View()

# slice()
bikes_tbl %>% 
  arrange(desc(price)) %>% 
  # slice(1:5)
  slice((nrow(.)-4):nrow(.))

# distinct(): extract unique values from data
bike_orderlines_wrangled_tbl %>% 
  distinct(category_1, category_2) %>% 
  View()

# mutate(): add new columns
bike_orderlines_wrangled_tbl %>% 
  mutate(total_price_log = log(total_price)) %>% 
  mutate(total_price_sqrt = total_price^0.5) %>% 
  View()

# Binning with ntile()
bike_orderlines_wrangled_tbl %>% 
  mutate(total_price_binned = ntile(total_price, 3)) %>% 
  View()

# case_when() example
bike_orderlines_wrangled_tbl %>% 
  mutate(total_price_binned = ntile(total_price, 3)) %>% 
  mutate(total_price_binned2 = case_when(
    total_price > quantile(total_price, 0.75) ~ "High",
    total_price > quantile(total_price, 0.25) ~ "Medium", 
    TRUE ~ "Low"
  )) %>% 
  View()
```

# 7. Grouping & summarizing

```{r grouping}
bike_orderlines_wrangled_tbl %>% 
  summarise(revenue = sum(total_price))

bike_orderlines_wrangled_tbl %>% 
  group_by(category_1) %>% 
  summarise(revenue = sum(total_price)) %>% 
  ungroup() %>% 
  arrange(desc(revenue))

bike_orderlines_wrangled_tbl %>%  
  group_by(category_1, category_2, frame_material) %>% 
  summarise(revenue = sum(total_price)) %>% 
  ungroup() %>% 
  arrange(desc(revenue))
```

# 8. Questions & quick answers

```{r q-and-a}
# Q1: What are the unique categories of products? 
bike_orderlines_wrangled_tbl %>% distinct(category_1)
bike_orderlines_wrangled_tbl %>% distinct(category_2)
bike_orderlines_wrangled_tbl %>% distinct(frame_material)

# Q2: Which product categories have the largest sales? (category_1)
bike_orderlines_wrangled_tbl %>% 
  select(category_1, total_price) %>% 
  group_by(category_1) %>% 
  summarise(sales = sum(total_price)) %>%
  ungroup() %>% 
  rename(`Primary Category` = category_1, 
         Sales = sales) %>% 
  # format dollars
  mutate(Sales1 = Sales %>% scales::dollar())
```

# 9. Time series / date handling (lubridate)

```{r timeseries}
# Check structure
str(bike_orderlines_wrangled_tbl)

bike_sales_y <- bike_orderlines_wrangled_tbl %>%
  select(order_date, total_price) %>% 
  # change order_date into ymd format
  mutate(order_date = ymd(order_date)) %>% 
  mutate(year = year(order_date)) %>% 
  # group by year
  group_by(year) %>% 
  summarise(sales = sum(total_price)) %>% 
  ungroup()

# monthly aggregation
bike_sales_m <- bike_orderlines_wrangled_tbl %>% 
  select(order_date, total_price) %>% 
  mutate(order_date = ymd(order_date)) %>% 
  mutate(year_month = floor_date(order_date, unit = "month")) %>%
  group_by(year_month) %>% 
  summarise(sales = sum(total_price))
```

# 10. Measuring change / lag & a helper function

```{r lag-and-function}
# Example mutate with lag (fix variable names from script)
bike_sales_y %>% 
  mutate(sales_lag_1 = lag(sales, n = 1)) %>% 
  # Replace NA with the first year's sales (if desired)
  mutate(sales_lag_1 = case_when(
    is.na(sales_lag_1) ~ sales,
    TRUE ~ sales_lag_1
  )) %>% 
  mutate(diff_1 = sales - sales_lag_1) %>% 
  mutate(pct_diff_1 = diff_1 / sales_lag_1) %>% 
  mutate(pct_diff_1_chr = scales::percent(pct_diff_1))

# Function to compute percent change
calculate_pct_diff <- function(data){
  data %>% 
    mutate(sales_lag_1 = lag(sales, n = 1)) %>% 
    mutate(sales_lag_1 = case_when(
      is.na(sales_lag_1) ~ sales,
      TRUE ~ sales_lag_1
    )) %>% 
    mutate(diff_1 = sales - sales_lag_1) %>% 
    mutate(pct_diff_1 = diff_1 / sales_lag_1) %>% 
    mutate(pct_diff_1_chr = scales::percent(pct_diff_1))
}

calculate_pct_diff(bike_sales_m)
```

# 11. Plots (ggplot2 / tidyquant theme)

```{r plots}
# yearly sales plot
bike_sales_y %>% 
  ggplot(aes(x = year, y = sales, color = sales)) +
  geom_point(size = 5) + 
  geom_line(linewidth = 2) + 
  geom_smooth(method =  "lm", formula = 'y ~ x', se = FALSE) +
  expand_limits(y = c(0, 20e6)) + 
  scale_colour_continuous(low = "red", high = "black", 
                          labels = scales::dollar_format(scale = 1/1e6, suffix = "M")) +
  scale_y_continuous(labels = scales::dollar_format(scale = 1/1e6, suffix = "M")) + 
  labs(
    title    = "Revenue",
    subtitle = "Sales are trending up and to the right!",
    x        = "year", 
    y        = "Sales (Millions)",
    color    = "Rev ($M)",
    caption  = "Total sales from 2011 to 2015"
  )

# Bar plot: revenue by category_2
revenue_by_category2_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(category_2, total_price) %>% 
  group_by(category_2) %>% 
  summarise(revenue = sum(total_price)) %>% 
  ungroup()

revenue_by_category2_tbl %>% 
  mutate(category_2 = category_2 %>% as_factor() %>% fct_reorder(desc(revenue))) %>% 
  ggplot(aes(category_2, revenue)) +
  geom_col(fill = "blue") +
  coord_flip()
```

# 12. More visualizations (scatter, histogram, density, boxplot, labels, lollipop, heatmap)

```{r more-plots}
# Scatter: order value
order_value_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(order_id, order_line, total_price, quantity) %>% 
  group_by(order_id) %>% 
  summarize(
    total_quantity = sum(quantity),
    total_price    = sum(total_price)
  ) %>% 
  ungroup()

order_value_tbl %>% 
  ggplot(aes(x = total_quantity, y = total_price)) +
  geom_point(alpha = 0.5, size = 2)

# Histogram / density
bike_orderlines_wrangled_tbl %>% 
  distinct(model, price) %>% 
  ggplot(aes(price)) +
  geom_histogram(bins = 30, fill = "blue", color = "white")

bike_orderlines_wrangled_tbl %>% 
  distinct(price, model, frame_material) %>% 
  ggplot(aes(price, fill = frame_material)) +
  geom_histogram() + 
  facet_wrap(~ frame_material, ncol = 1) + 
  scale_fill_tq() + 
  theme_tq()

# Density
bike_orderlines_wrangled_tbl %>% 
  distinct(price, model, frame_material) %>% 
  ggplot(aes(price, fill = frame_material)) +
  geom_density(alpha = 0.5)+
  scale_fill_tq() + 
  theme_tq()

# Box plot
unit_price_by_cat2_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(category_2, model, price) %>% 
  distinct() %>% 
  mutate(category_2 = as_factor(category_2) %>% fct_reorder(price))

unit_price_by_cat2_tbl %>% 
  ggplot(aes(category_2, price)) + 
  geom_boxplot() + 
  coord_flip() +
  theme_tq()
```

# 13. Adding text and labels to plots

```{r labels}
revenue_by_year <- bike_orderlines_wrangled_tbl %>% 
  select(order_date, total_price) %>% 
  mutate(year = year(order_date)) %>% 
  group_by(year) %>% 
  summarize(revenue = sum(total_price)) %>% 
  ungroup() 

revenue_by_year %>% 
  ggplot(aes(year, revenue)) + 
  geom_col(fill = "blue") + 
  geom_text(aes(label = scales::dollar(revenue, scale = 1e-6, suffix = "M")), 
            vjust = 1.5, color = "white") + 
  geom_label(label = "Major Demand This Year",
             vjust = -0.5, 
             size = 5) + 
  expand_limits(y = 2e7)
```

# 14. Top N customers (lollipop) & heatmaps

```{r topn-and-heatmaps}
n <- 10

topN_customers <- bike_orderlines_wrangled_tbl %>% 
  select(bikeshop_name, total_price) %>% 
  mutate(bikeshop_name = as_factor(bikeshop_name) %>% fct_lump(n = n, w = total_price)) %>% 
  group_by(bikeshop_name) %>% 
  summarize(revenue = sum(total_price)) %>% 
  ungroup() %>% 
  mutate(bikeshop_name = bikeshop_name %>% fct_reorder(revenue)) %>% 
  mutate(bikeshop_name = bikeshop_name %>% fct_relevel("Other", after =0)) %>% 
  arrange(desc(bikeshop_name)) %>% 
  mutate(revenue_text = scales::dollar(revenue)) %>% 
  mutate(cum_pct = cumsum(revenue) / sum(revenue)) %>% 
  mutate(cum_pct_txt = scales::percent(cum_pct)) %>% 
  mutate(rank = row_number()) %>% 
  mutate(rank = case_when(
    rank == max(rank) ~NA_integer_, 
    TRUE ~ rank
  )) %>% 
  mutate(label_text = str_glue("Rank: {rank}\nRev {revenue_text} \ncum {cum_pct_txt}"))

topN_customers %>% 
  ggplot(aes(revenue, bikeshop_name)) +
  geom_segment(aes(xend = 0, yend = bikeshop_name)) +
  geom_point(aes(size = revenue)) + 
  geom_label(aes(label = label_text), hjust = "inward")

# Heatmap of purchasing habits
pct_sales_by_customer_tbl <- bike_orderlines_wrangled_tbl %>% 
  select(bikeshop_name, category_1, category_2, quantity) %>% 
  group_by(bikeshop_name, category_1, category_2) %>% 
  summarise(total_qty = sum(quantity)) %>% 
  ungroup() %>% 
  group_by(bikeshop_name) %>% 
  mutate(pct = total_qty / sum(total_qty)) %>% 
  ungroup() %>% 
  mutate(bikeshop_name  = as.factor(bikeshop_name) %>% fct_rev()) %>% 
  mutate(bikeshop_name_num = as.numeric(bikeshop_name))

pct_sales_by_customer_tbl %>% 
  ggplot(aes(category_2, bikeshop_name)) +
  geom_tile(aes(fill = pct)) + 
  geom_text(aes(label = scales::percent(pct)), size = 3) +
  scale_fill_gradient(low = "white", high = "black") + 
  facet_wrap(~ category_1) + 
  labs(
    title = "Heatmap of purchasing habits", 
    x     = "Bike type (category 2)", 
    y     = "Customer"
  )

pct_sales_by_customer_tbl %>% 
  ggplot(aes(category_2, bikeshop_name)) +
  geom_tile(aes(fill = pct)) +
  geom_text(aes(label = scales::percent(pct, accuracy = 0.01L)), size = 3) +
  facet_wrap(~ category_1, scales = "free_x") +
  scale_fill_gradient(low = "white", high = palette_light()[1]) +
  labs(
    title = "Heatmaps of Purchasing Habits", 
    x     = "Bike Type (Category 2)", 
    y     = "Customer", 
    caption = str_glue(
      "Customers that prefer Road: Ann Arbor, Austin Cruisers, & Indianapolis

       Customers that prefer Mountain: Ithaca Mountain, Pittsburgh Mountain, & Tampa 29ers")
  ) + 
  theme_tq() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1), 
    legend.position = "none", 
    plot.title = element_text(face = "bold"), 
    plot.caption = element_text(face = "bold.italic")
  )
```

# 15. String manipulation & feature engineering

```{r string-fe}
# str_detect()
bikes_tbl %>% 
  select(model) %>% 
  mutate(supersix = model %>% str_detect("Supersix") %>% as.numeric()) %>% 
  mutate(black    = model %>% str_detect("Black") %>% as.numeric())

# Concatenation
order_id <- 1
order_line <- 1
str_c("Order Line: ", order_id, ".", order_line)

# str_glue
str_glue("Order Line: {order_id}.{order_line}")

bike_orderlines_tbl %>% 
  select(bikeshop_name, order_id, order_line) %>% 
  mutate(purchase_statement = str_glue(
    "Order Line: {order_id}.{order_line} sent to Customer: {str_to_upper(bikeshop_name)}"
  ) %>% as.character())

# Separating text
bikes_tbl %>% select(description) %>% 
  separate(col = description, 
           into = c("category_1", "category_2", "frame_material"),
           sep  = " - ", 
           remove = FALSE)
```

# 16. Feature engineering: model parsing example

This section shows how to clean model names and extract base and tier information.

```{r feature-engineering}
test <- bikes_tbl %>% select(model) %>% 
  # fix typo
  mutate(model = case_when(
    model == "CAAD Disc Ultegra" ~ "CAAD12 Disc Ultegra", 
    model == "Supersix Evo Hi-Mod Utegra" ~ "Supersix Evo Hi-Mod Ultegra",
    model == "Syapse Carbon Tiagra" ~ "Synapse Carbon Tiagra", 
    TRUE ~ model)
  ) %>% 
  # separating using spaces
  separate(col = model, 
           into = str_c("model_", 1:7), 
           sep = " ", 
           remove = FALSE, 
           fill = "right"
  ) %>% 
  mutate(model_base = case_when(
    # Fix Supersix Evo
    str_detect(str_to_lower(model_1), "supersix") ~ str_c(model_1, model_2, sep = " "),
    # Fix Beast of the East
    str_detect(str_to_lower(model_1), "beast") ~ str_c(model_1, model_2, model_3, model_4, sep = " "),
    # Fix Bad Habit
    str_detect(str_to_lower(model_1), "bad") ~ str_c(model_1, model_2, sep = " "), 
    # Fix Fat CAAD Bikes
    str_detect(str_to_lower(model_1), "fat") ~ str_c(model_1, model_2, sep = " "), 
    # Fix Scalpel 29
    str_detect(str_to_lower(model_1), "29") ~ str_c(model_1, model_2, sep = " "),
    # catch all
    TRUE ~ model_1
  )) %>% 
  # Get "tier" feature
  mutate(model_tier = model %>% str_replace(model_base, replacement = "") %>% str_trim()) %>% 
  # Remove unnecessary columns
  select(-matches("model_[0-9]")) %>% 
  # create flags using str_detect()
  mutate(black  = model_tier %>% str_to_lower() %>% str_detect("black") %>% as.numeric(),
         red    = model_tier %>% str_to_lower() %>% str_detect("red") %>% as.numeric(),
         hi_mod = model_tier %>% str_to_lower() %>% str_detect("hi_mod") %>% as.numeric(),
         team   = model_tier %>% str_to_lower() %>% str_detect("team") %>% as.numeric(),
         ultegra = model_tier %>% str_to_lower() %>% str_detect("ultegra") %>% as.numeric(),
         dura_ace = model_tier %>% str_to_lower() %>% str_detect("dura_ace") %>% as.numeric(),
         disc    = model_tier %>% str_to_lower() %>% str_detect("disc") %>% as.numeric())
```

# 17. Reusable function: separate_bike_model

```{r separate-function}
data <- bikes_tbl

separate_bike_model <- function(data, append = TRUE) {
  # If append == FALSE, only keep model column
  if (!append){
    data <- data %>% select(model)
  }

  output_tbl <- data %>% select(model) %>% 
    # fix typos
    mutate(model = case_when(
      model == "CAAD Disc Ultegra" ~ "CAAD12 Disc Ultegra", 
      model == "Supersix Evo Hi-Mod Utegra" ~ "Supersix Evo Hi-Mod Ultegra",
      model == "Syapse Carbon Tiagra" ~ "Synapse Carbon Tiagra", 
      TRUE ~ model)
    ) %>% 
    # separate using spaces
    separate(col = model, 
             into = str_c("model_", 1:7), 
             sep = " ", 
             remove = FALSE, 
             fill = "right"
    ) %>% 
    mutate(model_base = case_when(
      str_detect(str_to_lower(model_1), "supersix") ~ str_c(model_1, model_2, sep = " "),
      str_detect(str_to_lower(model_1), "beast") ~ str_c(model_1, model_2, model_3, model_4, sep = " "),
      str_detect(str_to_lower(model_1), "bad") ~ str_c(model_1, model_2, sep = " "), 
      str_detect(str_to_lower(model_1), "fat") ~ str_c(model_1, model_2, sep = " "), 
      str_detect(str_to_lower(model_1), "29") ~ str_c(model_1, model_2, sep = " "),
      TRUE ~ model_1
    )) %>% 
    mutate(model_tier = model %>% str_replace(model_base, replacement = "") %>% str_trim()) %>% 
    select(-matches("model_[0-9]")) %>% 
    mutate(black  = model_tier %>% str_to_lower() %>% str_detect("black") %>% as.numeric(),
           red    = model_tier %>% str_to_lower() %>% str_detect("red") %>% as.numeric(),
           hi_mod = model_tier %>% str_to_lower() %>% str_detect("hi_mod") %>% as.numeric(),
           team   = model_tier %>% str_to_lower() %>% str_detect("team") %>% as.numeric(),
           ultegra = model_tier %>% str_to_lower() %>% str_detect("ultegra") %>% as.numeric(),
           dura_ace = model_tier %>% str_to_lower() %>% str_detect("dura_ace") %>% as.numeric(),
           disc    = model_tier %>% str_to_lower() %>% str_detect("disc") %>% as.numeric())

  return(output_tbl)
}

separate_bike_model(data)
```

# Notes / Next steps

- When knitting, ensure the data files referenced in `./FDB_2025F/` exist relative to the Rmd file.
- For reproducible outputs, consider setting `echo = FALSE` for chunks you don't want displayed, or `eval = FALSE` for chunks that should not run (e.g., heavy installs).
- You can change `output` in the YAML to `pdf_document` or `word_document` if needed.
